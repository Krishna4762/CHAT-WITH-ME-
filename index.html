<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">

   <!--=============== REMIXICONS ===============-->
   <link href="https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css" rel="stylesheet">

   <!--=============== FIREBASE===============-->
   <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
   <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

   <title>Real-Time Chat System</title>
   <style>
      /*=============== GOOGLE FONTS ===============*/
      @import url("https://fonts.googleapis.com/css2?family=Poppins:wght@400;500&display=swap");

      /*=============== BASE ===============*/
      * {
        box-sizing: border-box;
        padding: 0;
        margin: 0;
      }

      body,
      input,
      button {
        font-size: 1rem;
        font-family: "Poppins", sans-serif;
      }

      body {
        color: hsl(0, 0%, 100%);
        background: #0f0f0f;
        height: 100vh;
        overflow: hidden;
      }

      input,
      button {
        border: none;
        outline: none;
      }

      a {
        text-decoration: none;
      }

      img {
        max-width: 100%;
        height: auto;
      }

      /*=============== LOGIN ===============*/
      .login {
        position: relative;
        height: 100vh;
        display: grid;
        align-items: center;
      }

      .login__img {
        position: absolute;
        width: 100%;
        height: 100%;
        object-fit: cover;
        object-position: center;
        z-index: -1;
      }

      .container {
        position: relative;
        background-color: hsla(0, 0%, 10%, 0.1);
        border: 2px solid white;
        margin-inline: 1.5rem;
        padding: 2.5rem 1.5rem;
        border-radius: 1rem;
        backdrop-filter: blur(10px);
      }

      .login__title {
        text-align: center;
        font-size: 1.75rem;
        font-weight: 500;
        margin-bottom: 2rem;
      }

      .login__content,
      .login__box {
        display: grid;
      }

      .login__content {
        row-gap: 1.75rem;
        margin-bottom: 1.5rem;
      }

      .login__box {
        grid-template-columns: max-content 1fr;
        align-items: center;
        column-gap: 0.75rem;
        border-bottom: 2px solid hsl(0, 0%, 100%);
      }

      .login__icon,
      .login__eye {
        font-size: 1.25rem;
      }

      .login__input {
        width: 100%;
        padding-block: 0.8rem;
        background: none;
        color: hsl(0, 0%, 100%);
        position: relative;
        z-index: 1;
      }

      .login__box-input {
        position: relative;
      }

      .login__label {
        position: absolute;
        left: 0;
        top: 13px;
        font-weight: 500;
        transition: top 0.3s, font-size 0.3s;
      }

      .login__eye {
        position: absolute;
        right: 0;
        top: 18px;
        z-index: 10;
        cursor: pointer;
      }

      .login__box:nth-child(2) input {
        padding-right: 1.8rem;
      }

      .login__check,
      .login__check-group {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .login__check {
        margin-bottom: 1.5rem;
      }

      .login__check-label,
      .login__forgot,
      .login__register {
        font-size: 0.813rem;
      }

      .login__check-group {
        column-gap: 0.5rem;
      }

      .login__check-input {
        width: 16px;
        height: 16px;
      }

      .login__forgot {
        color: hsl(0, 0%, 100%);
      }

      .login__forgot:hover {
        text-decoration: underline;
      }

      .login__button {
        width: 100%;
        padding: 1rem;
        border-radius: 0.5rem;
        background-color: hsl(0, 0%, 100%);
        font-weight: 500;
        cursor: pointer;
        margin-bottom: 2rem;
        transition: all 0.3s ease;
      }

      .login__button:hover {
        background-color: hsla(0, 0%, 100%, 0.8);
        transform: translateY(-2px);
      }

      .login__register {
        text-align: center;
      }

      .login__register a {
        color: hsl(0, 0%, 100%);
        font-weight: 500;
      }

      .login__register a:hover {
        text-decoration: underline;
      }

      /* Input focus move up label */
      .login__input:focus + .login__label {
        top: -12px;
        font-size: 0.813rem;
      }

      /* Input focus sticky top label */
      .login__input:not(:placeholder-shown).login__input:not(:focus) + .login__label {
        top: -12px;
        font-size: 0.813rem;
      }

      /*=============== SUCCESS MESSAGE ===============*/
      .success-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 100;
      }

      .success-content {
        text-align: center;
      }

      .success-icon {
        font-size: 4rem;
        color: #4ade80;
        margin-bottom: 1rem;
      }

      .success-title {
        font-size: 2rem;
        font-weight: 500;
        margin-bottom: 1rem;
      }

      .success-message {
        margin-bottom: 2rem;
      }

      /*=============== CHAT CONTAINER ===============*/
      .chat-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 200;
        padding: 1rem;
      }

      .chat-wrapper {
        width: 100%;
        max-width: 400px;
        height: 600px;
        display: flex;
        flex-direction: column;
        background-color: hsla(0, 0%, 10%, 0.1);
        border: 2px solid white;
        border-radius: 1rem;
        backdrop-filter: blur(10px);
        overflow: hidden;
      }

      /* Chat Header */
      .chat-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        background-color: hsla(0, 0%, 100%, 0.1);
        border-bottom: 1px solid hsla(0, 0%, 100%, 0.2);
      }

      .chat-user {
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .chat-user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: hsla(0, 0%, 100%, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .chat-user-avatar i {
        font-size: 1.25rem;
      }

      .chat-user-info h3 {
        font-size: 1rem;
        font-weight: 500;
      }

      .chat-user-info p {
        font-size: 0.75rem;
        color: #4ade80;
      }

      .chat-actions {
        display: flex;
        gap: 0.5rem;
      }

      .chat-close {
        font-size: 1.5rem;
        cursor: pointer;
        transition: color 0.3s;
      }

      .chat-close:hover {
        color: #ff6b6b;
      }

      /* Chat Messages */
      .chat-messages {
        flex: 1;
        padding: 1rem;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .message {
        display: flex;
        flex-direction: column;
        max-width: 80%;
        animation: fadeIn 0.3s ease;
      }

      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }

      .message.received {
        align-self: flex-start;
      }

      .message.sent {
        align-self: flex-end;
      }

      .message-content {
        padding: 0.75rem 1rem;
        border-radius: 1rem;
        position: relative;
      }

      .message.received .message-content {
        background-color: hsla(0, 0%, 100%, 0.2);
        border-top-left-radius: 0.25rem;
      }

      .message.sent .message-content {
        background-color: hsla(228, 100%, 84%, 0.3);
        border-top-right-radius: 0.25rem;
      }

      .message-content p {
        margin: 0;
        line-height: 1.4;
      }

      .message-time {
        font-size: 0.7rem;
        margin-top: 0.25rem;
        opacity: 0.7;
      }

      .message.received .message-time {
        align-self: flex-start;
      }

      .message.sent .message-time {
        align-self: flex-end;
      }

      /* Chat Input */
      .chat-input-container {
        padding: 1rem;
        background-color: hsla(0, 0%, 100%, 0.1);
        border-top: 1px solid hsla(0, 0%, 100%, 0.2);
      }

      .chat-input-wrapper {
        display: flex;
        gap: 0.5rem;
        align-items: center;
      }

      .chat-input {
        flex: 1;
        padding: 0.75rem 1rem;
        border-radius: 2rem;
        background-color: hsla(0, 0%, 100%, 0.1);
        color: white;
        border: 1px solid hsla(0, 0%, 100%, 0.2);
      }

      .chat-input::placeholder {
        color: hsla(0, 0%, 100%, 0.6);
      }

      .chat-send {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s;
        border: none;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      }

      .chat-send:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
      }

      .chat-send:active {
        transform: scale(0.95);
      }

      .chat-send i {
        font-size: 1.2rem;
        margin-left: 2px;
      }

      /* User indicator */
      .user-indicator {
        position: absolute;
        top: 10px;
        right: 10px;
        background: hsla(0, 0%, 100%, 0.2);
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.8rem;
        backdrop-filter: blur(10px);
      }

      /* Connection status */
      .connection-status {
        position: absolute;
        top: 10px;
        left: 10px;
        background: hsla(120, 100%, 25%, 0.3);
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.8rem;
        backdrop-filter: blur(10px);
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .connection-status.offline {
        background: hsla(0, 100%, 50%, 0.3);
      }

      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #4ade80;
      }

      .connection-status.offline .status-dot {
        background: #ff6b6b;
      }

      /* Loading spinner */
      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid hsla(0, 0%, 100%, 0.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      /*=============== BREAKPOINTS ===============*/
      /* For medium devices */
      @media screen and (min-width: 576px) {
        .login {
          justify-content: center;
        }

        .container {
          width: 400px;
          padding: 4rem 3rem 3.5rem;
          border-radius: 1.5rem;
        }

        .login__title {
          font-size: 2rem;
        }
        
        .chat-wrapper {
          height: 700px;
        }
      }
   </style>
</head>
<body>
   <!-- Background Image -->
   <img src="login-bg.png" alt="login image" class="login__img">

   <!-- Login Form -->
   <div class="login">
      <form action="" class="container" id="loginForm">
         <h1 class="login__title">Login</h1>

         <div class="login__content">
            <div class="login__box">
               <i class="ri-user-3-line login__icon"></i>

               <div class="login__box-input">
                  <input type="text" required class="login__input" id="login-email" placeholder=" " autocomplete="username">
                  <label for="login-email" class="login__label">Username</label>
               </div>
            </div>

            <div class="login__box">
               <i class="ri-lock-2-line login__icon"></i>

               <div class="login__box-input">
                  <input type="password" required class="login__input" id="login-pass" placeholder=" " autocomplete="current-password">
                  <label for="login-pass" class="login__label">Password</label>
                  <i class="ri-eye-off-line login__eye" id="login-eye"></i>
               </div>
            </div>
         </div>

         <div class="login__check">
            <div class="login__check-group">
               <input type="checkbox" class="login__check-input" id="login-check">
               <label for="login-check" class="login__check-label">Remember me</label>
            </div>

            <a href="#" class="login__forgot">Forgot Password?</a>
         </div>

         <button type="submit" class="login__button">Login</button>

         <p class="login__register">
            Don't have an account? <a href="#">Register</a>
         </p>
      </form>
   </div>
   
   <!-- Success Message Container -->
   <div class="success-container" id="successContainer">
      <div class="container">
         <div class="success-content">
            <i class="ri-checkbox-circle-fill success-icon"></i>
            <h2 class="success-title">Login Successful!</h2>
            <p class="success-message" id="userWelcome">You have successfully logged into your account.</p>
            <button class="login__button" id="chatButton">Open Chat</button>
         </div>
      </div>
   </div>
   
   <!-- Chat Container -->
   <div class="chat-container" id="chatContainer">
      <div class="connection-status" id="connectionStatus">
         <div class="status-dot"></div>
         <span>Connected to Firebase</span>
      </div>
      <div class="user-indicator" id="userIndicator">User: </div>
      <div class="chat-wrapper">
         <!-- Chat Header -->
         <div class="chat-header">
            <div class="chat-user">
               <div class="chat-user-avatar">
                  <i class="ri-user-fill"></i>
               </div>
               <div class="chat-user-info">
                  <h3 id="chatPartnerName">Chat Partner</h3>
                  <p id="onlineStatus">Online</p>
               </div>
            </div>
            <div class="chat-actions">
               <i class="ri-close-line chat-close" id="chatClose"></i>
            </div>
         </div>
         
         <!-- Chat Messages -->
         <div class="chat-messages" id="chatMessages">
            <div class="message received">
               <div class="message-content">
                  <p>Welcome to the chat! Made With Krishna ji.</p>
               </div>
               <span class="message-time" id="initialTime">Just now</span>
            </div>
         </div>
         
         <!-- Chat Input -->
         <div class="chat-input-container">
            <div class="chat-input-wrapper">
               <input type="text" class="chat-input" id="chatInput" placeholder="Type a message...">
               <button class="chat-send" id="chatSend">
                  <i class="ri-send-plane-fill"></i>
               </button>
            </div>
         </div>
      </div>
   </div>
   
   <script>
      // Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyBtRuaTkFPAl0DMOrdnNlEMAliPVj4nAkw",
        authDomain: "chat-me-176cf.firebaseapp.com",
        databaseURL: "https://chat-me-176cf-default-rtdb.firebaseio.com",
        projectId: "chat-me-176cf",
        storageBucket: "chat-me-176cf.firebasestorage.app",
        messagingSenderId: "441256742709",
        appId: "1:441256742709:web:e67e447a00c3b43c4b067c",
        measurementId: "G-8WHNV64YBE"
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const database = firebase.database();

      // User credentials - FIXED: Using proper user objects
      const users = {
         "krish": { password: "1", name: "Krishna" },
         "harsh": { password: "123", name: "Harsh" }
      };

      let currentUser = null;
      let messagesRef = null;
      let isChatInitialized = false; // Prevent multiple initializations

      document.addEventListener('DOMContentLoaded', function() {
         // Toggle password visibility
         const loginEye = document.getElementById('login-eye');
         const loginPass = document.getElementById('login-pass');
         
         loginEye.addEventListener('click', function() {
            if(loginPass.type === 'password') {
               loginPass.type = 'text';
               loginEye.classList.remove('ri-eye-off-line');
               loginEye.classList.add('ri-eye-line');
            } else {
               loginPass.type = 'password';
               loginEye.classList.remove('ri-eye-line');
               loginEye.classList.add('ri-eye-off-line');
            }
         });
         
         // Handle form submission - FIXED: Proper user validation
         const loginForm = document.getElementById('loginForm');
         const successContainer = document.getElementById('successContainer');
         const chatButton = document.getElementById('chatButton');
         const chatContainer = document.getElementById('chatContainer');
         const chatClose = document.getElementById('chatClose');
         const userWelcome = document.getElementById('userWelcome');
         const userIndicator = document.getElementById('userIndicator');
         const chatPartnerName = document.getElementById('chatPartnerName');
         const connectionStatus = document.getElementById('connectionStatus');
         
         loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const username = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-pass').value;
            
            console.log('Login attempt:', username, password); // Debug log
            
            // FIXED: Proper user validation
            if (users[username] && users[username].password === password) {
               currentUser = username;
               
               // Update UI with user info
               userWelcome.textContent = `Welcome ${users[username].name}!`;
               userIndicator.textContent = `User: ${users[username].name}`;
               
               // Determine partner
               const partner = username === 'krish' ? 'harsh' : 'krish';
               chatPartnerName.textContent = users[partner].name;
               
               // Show success message
               successContainer.style.display = 'flex';
               loginForm.style.display = 'none';
               
               console.log('Login successful for:', username); // Debug log
               
            } else {
               alert('Invalid username or password!\n\nTry:\nKrishna: krish / 1\nHarsh: harsh / 123');
               console.log('Login failed - users object:', users); // Debug log
            }
         });
         
         // Open chat when clicking Chat button
         chatButton.addEventListener('click', function() {
            successContainer.style.display = 'none';
            chatContainer.style.display = 'flex';
            
            // Initialize Firebase chat only once
            if (!isChatInitialized) {
               initializeFirebaseChat();
               isChatInitialized = true;
            }
         });
         
         // Close chat when clicking X button
         chatClose.addEventListener('click', function() {
            chatContainer.style.display = 'none';
            loginForm.style.display = 'block';
            loginForm.reset();
            
            // Clean up Firebase listeners
            if (messagesRef) {
               messagesRef.off();
            }
            isChatInitialized = false;
         });
         
         // Initialize Firebase chat functionality - FIXED: Prevent message duplication
         function initializeFirebaseChat() {
            // Reference to messages in Firebase
            messagesRef = database.ref('messages');
            
            // Clear existing messages (except the welcome message)
            const chatMessages = document.getElementById('chatMessages');
            const welcomeMessage = chatMessages.querySelector('.message.received');
            chatMessages.innerHTML = '';
            if (welcomeMessage) {
               chatMessages.appendChild(welcomeMessage);
            }
            
            // Track displayed message IDs to prevent duplicates
            const displayedMessageIds = new Set();
            
            // Load existing messages from Firebase - FIXED: Only load once
            messagesRef.once('value').then((snapshot) => {
               const messages = snapshot.val();
               if (messages) {
                  Object.entries(messages).forEach(([key, message]) => {
                     if (!displayedMessageIds.has(key)) {
                        displayMessage(message);
                        displayedMessageIds.add(key);
                     }
                  });
               }
            });
            
            // Listen for new messages in real-time - FIXED: Only new messages
            messagesRef.on('child_added', (snapshot) => {
               const messageKey = snapshot.key;
               const message = snapshot.val();
               
               // Only display if not already displayed
               if (!displayedMessageIds.has(messageKey)) {
                  displayMessage(message);
                  displayedMessageIds.add(messageKey);
               }
            });
            
            // Send message functionality
            const chatInput = document.getElementById('chatInput');
            const chatSend = document.getElementById('chatSend');
            
            chatSend.addEventListener('click', sendMessageToFirebase);
            chatInput.addEventListener('keypress', function(e) {
               if (e.key === 'Enter') {
                  sendMessageToFirebase();
               }
            });
            
            function sendMessageToFirebase() {
               const messageText = chatInput.value.trim();
               if (messageText && currentUser) {
                  const message = {
                     text: messageText,
                     sender: currentUser,
                     senderName: users[currentUser].name,
                     timestamp: Date.now()
                  };
                  
                  // Push message to Firebase
                  messagesRef.push(message)
                     .then(() => {
                        // Clear input on success
                        chatInput.value = '';
                        chatInput.focus();
                     })
                     .catch((error) => {
                        console.error('Error sending message:', error);
                        alert('Error sending message. Please try again.');
                     });
               }
            }
         }
         
         // Display a message in the chat
         function displayMessage(message) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${message.sender === currentUser ? 'sent' : 'received'}`;
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            
            const messageText = document.createElement('p');
            messageText.textContent = message.text;
            
            const messageTime = document.createElement('span');
            messageTime.className = 'message-time';
            
            // Format timestamp
            const date = new Date(message.timestamp);
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            messageTime.textContent = `${hours}:${minutes}`;
            
            messageContent.appendChild(messageText);
            messageDiv.appendChild(messageContent);
            messageDiv.appendChild(messageTime);
            
            chatMessages.appendChild(messageDiv);
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
         }
         
         // Set initial time for welcome message
         const now = new Date();
         const hours = now.getHours().toString().padStart(2, '0');
         const minutes = now.getMinutes().toString().padStart(2, '0');
         document.getElementById('initialTime').textContent = `${hours}:${minutes}`;
         
         // Update connection status based on Firebase connection
         const connectedRef = database.ref(".info/connected");
         connectedRef.on("value", (snap) => {
            if (snap.val() === true) {
               connectionStatus.classList.remove('offline');
               connectionStatus.innerHTML = '<div class="status-dot"></div><span>Connected to Firebase</span>';
            } else {
               connectionStatus.classList.add('offline');
               connectionStatus.innerHTML = '<div class="status-dot"></div><span>Offline - Reconnecting...</span>';
            }
         });
      });
   </script>
</body>
   </html>
